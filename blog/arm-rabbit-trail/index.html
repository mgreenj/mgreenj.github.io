<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> ARM: Going down a rabbit trail in ARM - The Code Guardian </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Learn about ARM AAPCS and THUMB ISA.- ARM: Going down a rabbit trail in ARM"> <meta name="keywords" content="ARM: Going down a rabbit trail in ARM, The Code Guardian, arm, architecture, cpu,arm, cpu, architecture, isa"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="The Code Guardian" property="og:site_name" /> <meta content="ARM: Going down a rabbit trail in ARM" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Learn about ARM AAPCS and THUMB ISA." property="og:description" /> <meta content="/blog/arm-rabbit-trail/" property="og:url" /> <meta content="2024-05-25T18:15:00+00:00" property="article:published_time" /> <meta content="/about/" property="article:author" /> <meta content="/assets/img/posts/arm-cpu.png" property="og:image" /> <meta content="arm" property="article:section" /> <meta content="architecture" property="article:tag" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="ARM: Going down a rabbit trail in ARM" /> <meta name="twitter:url" content="/blog/arm-rabbit-trail/" /> <meta name="twitter:description" content="Learn about ARM AAPCS and THUMB ISA." /> <link rel="stylesheet" href="/assets/css/main.css" /> <!-- <link rel="stylesheet" href="/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = '' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="/assets/js/mode-switcher.js"></script> <script src="/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="/assets/js/search.js"></script> <script src="/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!-- (you can remove the below scripts but do buy me a coffee to show some support :) --> <!-- Maker widget --> <!-- <script> (function(d, h, m){ var js, fjs = d.getElementsByTagName(h)[0]; if (d.getElementById(m)){return;} js = d.createElement(h); js.id = m; js.onload = function(){ window.makerWidgetComInit({ position: "left", widget: "fpxmrokbtojuu96d-wopkbgn3zvyakwcl-ajbpqueomjtmrw1x" })}; js.src = "https://makerwidget.com/js/embed.js"; fjs.parentNode.insertBefore(js, fjs) }(document, "script", "dhm")) </script> --> <!-- buy me a coffeee --> <!-- <script data-name="BMC-Widget" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="mauriceg" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF813F" data-position="right" data-x_margin="10" data-y_margin="10" ></script> --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">The Code Guardian</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="/contact" >Contact</a > </li> <li class="nav-item"> <a class="nav-link" href="https://docs.thecodeguardian.dev" >Knowledge Base</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link" href="/disclaimer"> Legal Disclaimer </a> </li> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch theme-toggle" type="checkbox" name="checkbox" /> </li> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">ARM: Going down a rabbit trail in ARM</h1> <h4 class="post-meta">Learn about ARM AAPCS and THUMB ISA.</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="/blog/authors/Maurice">Maurice</a></span> </span > on <time datetime="2024-05-25 18:15:00 +0000" itemprop="datePublished" >May 25, 2024</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/arm-rabbit-trail/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/arm" >arm</a > &nbsp; <a href="/blog/categories/architecture" >architecture</a > &nbsp; <a href="/blog/categories/cpu" >cpu</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="/assets/img/posts/arm-cpu.png" alt="" /> <br /> <br /> <h1 id="how-it-started">How it started</h1> <p>Earlier today I as looking at some code that I wrote on <a href="https://godbolt.org/">godbolt.org</a> and noticed an interesting symbol named <code class="language-plaintext highlighter-rouge">__aeabi_idivmod</code>. The code included an implementation of gcd(a, b), following the Euclidean (non-extended) algorithm, which includes modulo operation. The assembly label that included the reference to the previous symbol is included below.</p><pre><code class="language-ArmAsm">.L31:
        mov     r1, r4
        bl      __aeabi_idivmod
        mov     r0, r4
        cmp     r1, #0
        bne     .L40
        cmp     r4, #1
        beq     .L41
</code></pre><p>Curiosity prompted an investigation into <code class="language-plaintext highlighter-rouge">__aeabi_idivmod</code>; I was able to find the <a href="https://codebrowser.dev/llvm/compiler-rt/lib/builtins/arm/aeabi_idivmod.S.html">ARM assembler file</a> that includes the definition for this modulo division. This is an obvious reference to an ABI and I found some <a href="https://github.com/ARM-software/abi-aa/blob/main/rtabi32/rtabi32.rst#other-c-and-assembly-language-helper-functions">helpful documentation</a> on GitHub that provides some interesting information. One thing in particular stood out:</p> <blockquote> <p>Implementations of idiv, uidiv, idivmod, and uidivmod have full <a href="https://github.com/ARM-software/abi-aa/releases">AAPCS32</a> privileges and may corrupt any register an AAPCS-conforming call may corrupt.</p> </blockquote> <h2 id="what-is-aapcs32">What is AAPCS32?</h2> <p>Full documentation on AACS32 can be found <a href="https://github.com/ARM-software/abi-aa/releases/download/2023Q3/aapcs32.pdf">here</a>. Notably, the order of function parameter matters. According to the AACS32 documentation, the following general purpose registers are relevant: r0, r1, r2, and r3. (For additional information on ARM registers, please refer to my <a href="https://docs.thecodeguardian.dev/v/reverse-engineering/arm-registers">GitBook Reverse Engineering page</a>). Note that the majority of my notes are included in the <a href="https://docs.thecodeguardian.dev/">Low Level Computing</a> page and not the Reverse Engineering page.</p> <p>According to the AACS32, registers r0 &amp; r1 are scratch registers for results, while r2 &amp; r3 are scratch registers for other use. Crucially, AACS32 defines different behavior for datatypes that exceed 32-bits.</p> <p>The first four registers (r0, r1, r2, and r3) are used to pass argument values into a subroutine and return a result. Something else worth mentioning, is that AAPCS32 seems to be linked to the THUMB ISA.</p> <blockquote> <p>The AAPCS requires that all sub-routine call and return sequences support inter-working between Arm and Thumb states….</p> </blockquote> <p>In the snippet above, you’ll notice that the instruction is <code class="language-plaintext highlighter-rouge">bl</code> or branch with link; an instruction that, according to the AAPCS32, is used to call a subroutine. Remember that general purpose register r14 on an ARM architecture is used for link; that is, r14 will hold the address to return when a subroutine call completes.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">gcd</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">gcd</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Looking at the function above, the subroutine call to <code class="language-plaintext highlighter-rouge">__aeabi_idivmod</code> is implementing gcd(b, a % b). The assembly shows that a value in the register r4 is moved in r1, which is a scratch register used for arguments (along with r3). The <code class="language-plaintext highlighter-rouge">bl</code> instruction calls the subroutine and stores the return address in <code class="language-plaintext highlighter-rouge">r14</code> the Link register. The quotient is stored in <code class="language-plaintext highlighter-rouge">r0</code> and the remainder in <code class="language-plaintext highlighter-rouge">r1</code>.</p> <p>I believe the <code class="language-plaintext highlighter-rouge">mov r0, r4</code> instruction is moving the value for b into <code class="language-plaintext highlighter-rouge">r0</code> for a comparison, <code class="language-plaintext highlighter-rouge">if (b == 0)</code>. The instructoin <code class="language-plaintext highlighter-rouge">cmp r1, #0</code> compares the remainder (int <code class="language-plaintext highlighter-rouge">r1</code>) to 0</p> <p>The remaining assmebly is self-explanatory.</p> <h2 id="why-did-i-investigate-this">Why did I investigate this?</h2> <p>Learning about the internals of a CPU (or anything in general) is always beneficial in cybersecurity. The more you know, the capable you are as a security researcher.</p> <p>Additionally, I find this topic interesting, and enjoy learning about the internals of a CPU and the compiler.</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="/blog/arm-rabbit-trail/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Maurice </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="/assets/img/authors/maurice.png" alt="Maurice" /> </div> <div class="col-md-6"> <p class="author_bio">DevOps Engineer & Security Researcher</p> <p>Email : maurice.green@thecodeguardian.dev</p> <p>Website : http://thecodeguardian.dev</p> <p class="profile-links"> <a class="social-link" href="https://github.com/0x0M03II" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.twitter.com/Maurice_GreenJr" target="_blank"><i class="fab fa-twitter fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <script> var disqus_config = function () { this.page.url = "/blog/arm-rabbit-trail/"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/Rabbit-Trail-ARM"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://thecodeguardian-dev.disqus.com.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Maurice</div> <div class="card-body"> <p class="author_bio">Hello! I am a security and CS enthusiast and most importantly a partaker of the grace of God and a follower of Jesus! Check out my other Blogs: - <a href="https://www.excellencyofchrist.blog">Excellency Of Christ</a>, - <a href="https://www.romans1520.blog">Romans 15:20</a>. </p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/0x0M03II/AES-Encryption" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star 0x0m03ii/AES-Encryption on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#kernel"></div> <li class="tag-head"> <a href="/blog/categories/kernel">kernel</a> </li> <a name="kernel"></a> <div id="#reverse-engineering"></div> <li class="tag-head"> <a href="/blog/categories/reverse-engineering">reverse-engineering</a> </li> <a name="reverse-engineering"></a> <div id="#linux"></div> <li class="tag-head"> <a href="/blog/categories/linux">linux</a> </li> <a name="linux"></a> <div id="#operating-systems"></div> <li class="tag-head"> <a href="/blog/categories/operating-systems">operating-systems</a> </li> <a name="operating-systems"></a> <div id="#encryption"></div> <li class="tag-head"> <a href="/blog/categories/encryption">encryption</a> </li> <a name="encryption"></a> <div id="#math"></div> <li class="tag-head"> <a href="/blog/categories/math">math</a> </li> <a name="math"></a> <div id="#security"></div> <li class="tag-head"> <a href="/blog/categories/security">security</a> </li> <a name="security"></a> <div id="#algorithm"></div> <li class="tag-head"> <a href="/blog/categories/algorithm">algorithm</a> </li> <a name="algorithm"></a> <div id="#programming"></div> <li class="tag-head"> <a href="/blog/categories/programming">programming</a> </li> <a name="programming"></a> <div id="#arm"></div> <li class="tag-head"> <a href="/blog/categories/arm">arm</a> </li> <a name="arm"></a> <div id="#architecture"></div> <li class="tag-head"> <a href="/blog/categories/architecture">architecture</a> </li> <a name="architecture"></a> <div id="#cpu"></div> <li class="tag-head"> <a href="/blog/categories/cpu">cpu</a> </li> <a name="cpu"></a> <div id="#operating systems"></div> <li class="tag-head"> <a href="/blog/categories/operating systems">operating systems</a> </li> <a name="operating systems"></a> <div id="#hpc"></div> <li class="tag-head"> <a href="/blog/categories/hpc">hpc</a> </li> <a name="hpc"></a> <div id="#networking"></div> <li class="tag-head"> <a href="/blog/categories/networking">networking</a> </li> <a name="networking"></a> <div id="#systems"></div> <li class="tag-head"> <a href="/blog/categories/systems">systems</a> </li> <a name="systems"></a> <div id="#rust"></div> <li class="tag-head"> <a href="/blog/categories/rust">rust</a> </li> <a name="rust"></a> <div id="#opinion"></div> <li class="tag-head"> <a href="/blog/categories/opinion">opinion</a> </li> <a name="opinion"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="/">Home</a> </li> <li> <a href="/about">About</a> </li> <li> <a href="/blog">Blog</a> </li> <li> <a href="/contact">Contact</a> </li> <li> <a href="https://docs.thecodeguardian.dev">Knowledge Base</a> </li> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> </div><footer> <p> Powered by<a href="https://0x0M03II.github.io"> devlopr jekyll</a>. Hosted with <a href="https://pages.github.com">Github Pages</a>. </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>
